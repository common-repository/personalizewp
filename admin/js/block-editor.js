(()=>{"use strict";const e=window.React,t=window.wp.i18n,l=window.wp.data,n=window.wp.hooks,r=window.wp.blocks,s=window.wp.coreData,o=window.wp.blockEditor,a=window.wp.components,i=window.wp.element,p=e=>[Object,Array].includes((e||{}).constructor)&&!Object.entries(e||{}).length,c=e=>(e=(e=(e=e.replace(/^,+|,+(?=,)/g,"")).split(",")).filter(Boolean),[...new Set(e.map((e=>parseInt(e,10))))]),d=e=>{const{wpDxpId:t,wpDxpRule:l,wpDxpAction:n,wpDxpSegment:r,pwpMinScore:s,pwpMaxScore:o,pwpPassword:a,pwpUserRoles:i,pwpUsers:d}=e,u={...e};delete u.wpDxpId,delete u.wpDxpRule,delete u.wpDxpAction,delete u.wpDxpSegment,delete u.pwpMinScore,delete u.pwpMaxScore,delete u.pwpPassword,delete u.pwpUserRoles,delete u.pwpUsers;let m=!1;const g={blockID:w(),action:n&&""!==n?n:"show"};l&&""!==l&&(m=!0,g.rules=c(l));const x={};if(r&&""!==r&&(x.segments=c(r)),s&&""!==s&&(x.minScore=s),o&&""!==o&&(x.maxScore=o),a&&""!==a&&(x.password=a),i&&!p(i)&&(x.userRoles=i),d&&!p(d)&&(x.users=d),m||!p(x))return Object.assign(g,x)},w=()=>crypto.randomUUID?crypto.randomUUID():u(),u=()=>"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(function(e){var t=16*Math.random()|0;return("x"==e?t:3&t|8).toString(16)}));function m(l){var n;const{blockAtts:r,setPersonalizeWPAtts:s,settings:o}=l;if(!o?.rules||0>=o.rules.length)return null;const i=[{value:0,label:(0,t.__)("-- Select a rule --","personalizewp")}].concat(...Array.from(o.rules).map((function(e){return{value:parseInt(e.id,10),label:e.name,disabled:!e.is_usable}}))),p=e=>(e=e.map((e=>parseInt(e,10))),[...new Set(e)]);let c=null!==(n=r?.rules)&&void 0!==n?n:[0];return c&&0!==c.length||(c=[0]),(0,e.createElement)("div",{className:"pwp-panel rules"},(0,e.createElement)(a.Flex,{direction:"column",align:"flex-start"},(0,e.createElement)(a.FlexItem,null,(0,e.createElement)("p",null,(0,t.__)("IF the user meets the following:","personalizewp")))),(0,e.createElement)(a.Flex,{direction:"row",align:"flex-start"},(0,e.createElement)(a.FlexItem,null,(0,e.createElement)("h3",null,(0,t.__)("Rules","personalizewp"))),(0,e.createElement)(a.FlexItem,null,(0,e.createElement)(a.Tooltip,{delay:200,text:(0,t.__)("If you add multiple rules these will be calculated using AND and return true if ALL rules are met.","personalizewp"),className:"pwp-tooltip",placement:"bottom-end"},(0,e.createElement)("div",null,(0,e.createElement)(a.Icon,{icon:"editor-help"}))))),c.map(((l,n)=>(0,e.createElement)(a.Flex,{direction:"row","data-key":"i"+n,key:"pwp-rule-"+n,className:"select-rule"},(0,e.createElement)(a.SelectControl,{label:0===n?(0,t.__)("Rules","personalizewp"):"",hideLabelFromVision:!0,value:String(l),options:i,onChange:e=>{((e,t)=>{c[e]=t,s({rules:p(c)})})(n,e)}}),c.length>1&&(0,e.createElement)(a.Button,{style:{padding:"0",minWidth:"min-content"},icon:"remove",onClick:()=>{(e=>{c.splice(e,1),s({rules:p(c)})})(n)}}),0!==l&&n===c.length-1&&(0,e.createElement)(a.Button,{style:{padding:"0",minWidth:"min-content"},icon:"insert",onClick:()=>{c.splice(c.length,0,0),s({rules:p(c)})}})))))}const g={wpDxpId:{type:"string"},wpDxpRule:{type:"string"},wpDxpAction:{type:"string"},wpDxpSegment:{type:"string"},pwpMinScore:{type:"string"},pwpMaxScore:{type:"string"},pwpPassword:{type:"string"},pwpUserRoles:{type:"array"},pwpUsers:{type:"array"}},x=(0,a.withFilters)("personalizeWP.addInspectorControls")((t=>(0,e.createElement)(e.Fragment,null))),b=(0,a.withFilters)("personalizeWP.addInspectorPanels")((t=>(0,e.createElement)(e.Fragment,null)));function y(r){var c,u;const{attributes:y,globallyRestricted:h,widgetAreaRestricted:E,name:z,setAttributes:f,isSelected:k,clientId:v}=r;if(!k)return null;(0,i.useEffect)((()=>{if(y&&Object.hasOwn(y,"wpDxpId")&&!Object.hasOwn(y,"personalizewp")){const e={};for(const t in g)e[t]=void 0;const t=Object.assign(e,{personalizewp:d(y)});f(t)}}),[y]);const P=(0,s.useEntityRecord)("personalizewp/v1","settings");if(P.isResolving)return(0,e.createElement)(o.InspectorControls,{group:"settings"},(0,e.createElement)(a.PanelBody,{title:(0,t.__)("Personalize","personalizewp")},(0,e.createElement)("div",{className:"pwp-panel rules"},(0,e.createElement)(a.Spinner,null))));const I=P.record,{getBlocks:_}=(0,l.select)("core/block-editor"),S=_().filter((e=>"core/widget-area"===e.name));if(E.includes(z)&&S.length>0||h.includes(z))return null;let D=null!==(c=y?.personalizewp)&&void 0!==c?c:{};function F(e){let t=Object.assign({blockID:"",action:"show"},{...D},{...e});const l=(0,n.applyFilters)("personalizeWP.hasRequiredFields",(r=t,Object.hasOwn(r,"rules")&&0<r.rules.filter(Boolean).length),t);var r;l&&""===t.blockID?t.blockID=w():l||(t=void 0),f({personalizewp:t})}return(0,e.createElement)(o.InspectorControls,{group:"settings"},(0,e.createElement)(a.PanelBody,{title:(0,t.__)("Personalize","personalizewp")},(0,e.createElement)(m,{blockAtts:D,setPersonalizeWPAtts:F,settings:I,...r}),(0,e.createElement)(x,{blockAtts:D,setPersonalizeWPAtts:F,settings:I,...r}),(0,e.createElement)("div",{className:"pwp-panel action"},(0,e.createElement)(a.SelectControl,{label:(0,t.__)("THEN take the following action:","personalizewp"),labelPosition:"top",value:null!==(u=D?.action)&&void 0!==u?u:"show",options:[{value:"show",label:(0,t.__)("Show block","personalizewp")},{value:"hide",label:(0,t.__)("Hide block","personalizewp")}],onChange:e=>F({action:e}),disabled:p(D),__nextHasNoMarginBottom:!0}))),(0,e.createElement)(b,{blockAtts:D,setPersonalizeWPAtts:F,settings:I,...r}))}const h={blockID:{type:"string"},rules:{type:"array",items:{type:"integer"}},action:{enum:["show","hide"],default:"show"}};(0,l.dispatch)("core").addEntities([{label:(0,t.__)("PersonalizeWP Settings","personalizewp"),kind:"personalizewp/v1",name:"settings",baseURL:"/personalizewp/v1/settings"}]);const E=(0,n.applyFilters)("personalizeWP.globallyRestrictedBlockTypes",["core/freeform","core/legacy-widget","core/widget-area"]),z=(0,n.applyFilters)("personalizeWP.widgetAreaRestrictedBlockTypes",["core/html"]);(0,n.addFilter)("blocks.registerBlockType","personalizewp/add-attributes",(function(e){if(E.includes(e.name))return e;const t={personalizewp:{type:"object",properties:(0,n.applyFilters)("personalizeWP.attributes",h)}};var l;return(0,r.hasBlockSupport)(e,"inserter",!0)&&!e.hasOwnProperty("parent")&&(e.attributes=Object.assign(e.attributes,t,g),e.supports=Object.assign(null!==(l=e?.supports)&&void 0!==l?l:{},{personalizewp:!0})),e})),(0,n.addFilter)("editor.BlockEdit","personalizewp/add-inspector-controls",(function(t){return l=>l.isSelected?(0,e.createElement)(e.Fragment,null,(0,e.createElement)(t,{...l}),(0,e.createElement)(y,{globallyRestricted:E,widgetAreaRestricted:z,...l})):(0,e.createElement)(t,{...l})}),90)})();